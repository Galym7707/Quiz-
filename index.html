<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SAT Vocab Trainer</title>
  <meta name="theme-color" content="#0b1220" />
  <style>
    :root{
      --bg0:#070a12;
      --bg1:#0b1220;
      --card: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.10);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --muted2: rgba(255,255,255,.55);
      --good: rgba(84, 255, 176, .95);
      --bad: rgba(255, 102, 102, .95);
      --accent: rgba(124, 193, 234, .95);
      --shadow: 0 18px 50px rgba(0,0,0,.40);
      --r: 22px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(124,193,234,.22), transparent 55%),
        radial-gradient(1000px 700px at 90% 10%, rgba(255,120,180,.14), transparent 60%),
        radial-gradient(1100px 900px at 40% 110%, rgba(84,255,176,.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }

    .shell{
      width:min(980px, 100%);
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 10px 14px;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
    }

    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 220px;
    }
    .logo{
      width:34px; height:34px;
      border-radius: 12px;
      background:
        radial-gradient(10px 10px at 25% 30%, rgba(255,255,255,.35), transparent 60%),
        linear-gradient(135deg, rgba(124,193,234,.95), rgba(84,255,176,.75));
      box-shadow: 0 10px 26px rgba(124,193,234,.14);
      border: 1px solid rgba(255,255,255,.20);
    }
    .brand h1{
      margin:0;
      font-size: 14px;
      letter-spacing:.4px;
      font-weight: 740;
      line-height: 1.1;
    }
    .brand p{
      margin:2px 0 0 0;
      font-size: 12px;
      color: var(--muted);
    }

    .stats{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      display:flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      font-size: 12px;
      color: var(--muted);
      user-select:none;
    }
    .dot{
      width:8px; height:8px; border-radius: 99px;
      background: rgba(255,255,255,.25);
    }
    .dot.good{ background: rgba(84,255,176,.95); }
    .dot.bad{ background: rgba(255,102,102,.95); }
    .dot.acc{ background: rgba(124,193,234,.95); }

    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap: 14px;
    }

    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
      .brand{ min-width:auto; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }

    .cardHead{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }

    .progressWrap{
      display:flex; flex-direction:column; gap:8px; width:100%;
    }
    .progressLine{
      width:100%;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .progressBar{
      height:100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(124,193,234,.95), rgba(84,255,176,.85));
      box-shadow: 0 10px 25px rgba(124,193,234,.12);
      transition: width .35s ease;
    }
    .progressMeta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      font-size: 12px;
      color: var(--muted);
    }

    .btnRow{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }

    .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.20);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 650;
      font-size: 13px;
      cursor:pointer;
      transition: transform .08s ease, background .18s ease, border-color .18s ease, opacity .18s ease;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.22); }
    .btn:active{ transform: scale(.98); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .btn.primary{
      background: linear-gradient(135deg, rgba(124,193,234,.95), rgba(84,255,176,.78));
      border-color: rgba(255,255,255,.18);
      color: rgba(0,0,0,.85);
    }

    .btn.ghost{
      background: transparent;
      border-color: rgba(255,255,255,.16);
      color: var(--muted);
    }

    .mainBody{
      padding: 16px;
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    .wordBox{
      padding: 16px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }

    .word{
      display:flex;
      flex-direction:column;
      gap: 6px;
      min-width: 0;
    }

    .word .label{
      color: var(--muted);
      font-size: 12px;
      letter-spacing:.35px;
      user-select:none;
    }

    .word .term{
      font-size: clamp(24px, 4.2vw, 40px);
      font-weight: 820;
      letter-spacing: .2px;
      line-height: 1.08;
      margin:0;
      word-break: break-word;
    }

    .subline{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
      color: var(--muted2);
      font-size: 12px;
      user-select:none;
    }

    .chip{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--muted);
    }

    .options{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 520px){
      .options{ grid-template-columns: 1fr; }
    }

    .opt{
      text-align:left;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      transition: transform .08s ease, background .18s ease, border-color .18s ease, box-shadow .18s ease;
      display:flex;
      gap: 10px;
      align-items:flex-start;
      min-height: 54px;
    }
    .opt:hover{
      background: rgba(255,255,255,.09);
      border-color: rgba(255,255,255,.22);
    }
    .opt:active{ transform: scale(.99); }
    .opt:disabled{ cursor:not-allowed; opacity:.92; }

    .k{
      flex: 0 0 auto;
      width: 24px; height: 24px;
      display:grid; place-items:center;
      border-radius: 9px;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--muted);
      font-size: 12px;
      font-weight: 760;
      margin-top: 1px;
    }

    .t{
      flex: 1 1 auto;
      font-size: 14px;
      font-weight: 700;
      line-height: 1.25;
    }

    .opt.correct{
      border-color: rgba(84,255,176,.60);
      background: rgba(84,255,176,.10);
      box-shadow: 0 12px 26px rgba(84,255,176,.10);
    }
    .opt.wrong{
      border-color: rgba(255,102,102,.60);
      background: rgba(255,102,102,.10);
      box-shadow: 0 12px 26px rgba(255,102,102,.10);
    }

    .footerRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      padding-top: 2px;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.60);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 999px;
      padding: 10px 12px;
      color: rgba(255,255,255,.92);
      font-size: 13px;
      box-shadow: 0 18px 45px rgba(0,0,0,.45);
      backdrop-filter: blur(12px);
      opacity:0;
      pointer-events:none;
      transition: opacity .25s ease, transform .25s ease;
      max-width: min(720px, calc(100% - 24px));
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-4px);
    }

    .side{
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .panel{
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .panel h3{
      margin:0;
      font-size: 13px;
      color: var(--muted);
      letter-spacing:.3px;
      font-weight: 780;
    }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
    }

    .select{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      outline:none;
      font-weight: 700;
    }

    .toggle{
      display:flex;
      align-items:center;
      gap: 10px;
      user-select:none;
    }
    .switch{
      width: 46px; height: 28px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      position:relative;
      cursor:pointer;
      flex: 0 0 auto;
      transition: background .18s ease, border-color .18s ease;
    }
    .knob{
      width: 22px; height: 22px;
      border-radius: 999px;
      background: rgba(255,255,255,.86);
      position:absolute;
      top: 50%;
      left: 4px;
      transform: translateY(-50%);
      transition: left .18s ease, background .18s ease;
      box-shadow: 0 12px 25px rgba(0,0,0,.30);
    }
    .switch.on{
      background: rgba(84,255,176,.18);
      border-color: rgba(84,255,176,.32);
    }
    .switch.on .knob{ left: 20px; background: rgba(84,255,176,.95); }

    .small{
      font-size: 12px;
      color: var(--muted2);
      line-height:1.35;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .mist{
      border-radius: 16px;
      padding: 10px 10px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
    }
    .mist .en{ font-weight: 820; }
    .mist .ru{ color: var(--muted); margin-top: 2px; }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-weight: 800;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--muted);
    }

    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 50;
    }
    .modalBack.show{ display:flex; }
    .modal{
      width: min(560px, 100%);
      border-radius: 22px;
      background: rgba(10,14,24,.72);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      backdrop-filter: blur(18px);
      overflow:hidden;
    }
    .modal .mh{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .modal .mh b{ font-size: 14px; letter-spacing:.2px; }
    .modal .mb{
      padding: 14px 16px;
      color: var(--muted);
      font-size: 13px;
      line-height:1.4;
    }
    .modal .mf{
      padding: 12px 16px 16px;
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="shell">
      <div class="topbar">
        <div class="brand">
          <div class="logo"></div>
          <div>
            <h1>SAT Vocab Trainer</h1>
            <p>English ‚Üí Russian quiz ‚Ä¢ progress saved</p>
          </div>
        </div>
        <div class="stats">
          <div class="pill" title="Correct answers"><span class="dot good"></span><span id="sCorrect">0</span></div>
          <div class="pill" title="Wrong answers"><span class="dot bad"></span><span id="sWrong">0</span></div>
          <div class="pill" title="Accuracy"><span class="dot acc"></span><span id="sAcc">0%</span></div>
          <div class="pill" title="Streak"><span class="dot"></span><span id="sStreak">0</span></div>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <div class="cardHead">
            <div class="progressWrap">
              <div class="progressMeta">
                <span id="pLabel">Ready</span>
                <span id="pMeta">0 / 0</span>
              </div>
              <div class="progressLine"><div class="progressBar" id="pBar"></div></div>
            </div>
            <div class="btnRow">
              <button class="btn ghost" id="btnSpeak" title="Pronounce (SpeechSynthesis)">üîä Speak</button>
              <button class="btn ghost" id="btnSkip" title="Mark wrong and move on (S)">Skip</button>
              <button class="btn primary" id="btnNext" disabled>Next</button>
            </div>
          </div>

          <div class="mainBody" id="main">
            <div class="wordBox">
              <div class="word">
                <div class="label">ENGLISH WORD</div>
                <h2 class="term" id="term">Press ‚ÄúStart‚Äù</h2>
                <div class="subline">
                  <span class="chip" id="modeChip">Mode: Smart</span>
                  <span class="chip">Keys: <span class="kbd">1</span> <span class="kbd">2</span> <span class="kbd">3</span> <span class="kbd">4</span> ‚Ä¢ Next: <span class="kbd">Enter</span></span>
                </div>
              </div>
              <div class="btnRow">
                <button class="btn" id="btnStart">Start</button>
                <button class="btn" id="btnRestart">Restart</button>
              </div>
            </div>

            <div class="options" id="options"></div>

            <div class="footerRow">
              <div class="small" id="hint">
                Tip: answer fast, use keyboard, results are saved locally in your browser.
              </div>
              <div class="btnRow">
                <button class="btn ghost" id="btnExport">Export results</button>
                <button class="btn ghost" id="btnClear">Clear saved data</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="side">
            <div class="panel">
              <h3>Practice settings</h3>
              <div class="row">
                <label class="small" for="mode">Mode</label>
              </div>
              <select class="select" id="mode">
                <option value="smart">Smart (prioritize weak words)</option>
                <option value="all">All words (full deck)</option>
                <option value="mistakes">Mistakes only</option>
              </select>

              <div class="row">
                <div class="toggle">
                  <div class="switch" id="swAuto"><div class="knob"></div></div>
                  <div>
                    <div style="font-weight:780;font-size:13px;">Auto-advance</div>
                    <div class="small">Move to next after answer</div>
                  </div>
                </div>

                <div class="toggle">
                  <div class="switch" id="swHard"><div class="knob"></div></div>
                  <div>
                    <div style="font-weight:780;font-size:13px;">Hard mode</div>
                    <div class="small">No ‚ÄúNext‚Äù until you answer</div>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="toggle">
                  <div class="switch" id="swSound"><div class="knob"></div></div>
                  <div>
                    <div style="font-weight:780;font-size:13px;">Sounds</div>
                    <div class="small">Tiny feedback beeps</div>
                  </div>
                </div>
              </div>

              <div class="small">
                Saved in <b>localStorage</b>. Works –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è Netlify.
              </div>
            </div>

            <div class="panel">
              <h3>Session</h3>
              <div class="row">
                <div class="pill"><span class="dot acc"></span><span id="sessionTime">00:00</span></div>
                <div class="pill"><span class="dot"></span><span id="sessionLeft">0 left</span></div>
              </div>
              <div class="small" id="sessionNote">Start a run to see stats.</div>
            </div>

            <div class="panel">
              <h3>Mistakes (this run)</h3>
              <div class="list" id="mistakesList">
                <div class="small">No mistakes yet.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="toast" id="toast"></div>

      <div class="modalBack" id="resumeBack" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true">
          <div class="mh">
            <b>Continue previous session?</b>
            <button class="btn ghost" id="btnCloseResume">Close</button>
          </div>
          <div class="mb" id="resumeText"></div>
          <div class="mf">
            <button class="btn ghost" id="btnDiscardResume">Start fresh</button>
            <button class="btn primary" id="btnResume">Continue</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { WORDS } from "./words.js";

    const STORAGE_KEY = "sat_vocab_trainer_v1";

    const el = (id) => document.getElementById(id);

    const ui = {
      term: el("term"),
      options: el("options"),
      btnNext: el("btnNext"),
      btnStart: el("btnStart"),
      btnRestart: el("btnRestart"),
      btnSkip: el("btnSkip"),
      btnSpeak: el("btnSpeak"),
      btnExport: el("btnExport"),
      btnClear: el("btnClear"),

      sCorrect: el("sCorrect"),
      sWrong: el("sWrong"),
      sAcc: el("sAcc"),
      sStreak: el("sStreak"),

      pLabel: el("pLabel"),
      pMeta: el("pMeta"),
      pBar: el("pBar"),

      mode: el("mode"),
      modeChip: el("modeChip"),

      swAuto: el("swAuto"),
      swHard: el("swHard"),
      swSound: el("swSound"),

      hint: el("hint"),

      mistakesList: el("mistakesList"),

      sessionTime: el("sessionTime"),
      sessionLeft: el("sessionLeft"),
      sessionNote: el("sessionNote"),

      resumeBack: el("resumeBack"),
      resumeText: el("resumeText"),
      btnResume: el("btnResume"),
      btnDiscardResume: el("btnDiscardResume"),
      btnCloseResume: el("btnCloseResume"),
    };

    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

    const shuffle = (arr) => {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    };

    const nowISO = () => new Date().toISOString();

    const safeJsonParse = (s) => {
      try { return JSON.parse(s); } catch { return null; }
    };

    const base = {
      version: 1,
      settings: { mode: "smart", autoAdvance: true, hardMode: false, sounds: false },
      totals: {
        correct: 0,
        wrong: 0,
        sessions: []
      },
      perWord: {},
      run: null
    };

    const load = () => {
      const raw = localStorage.getItem(STORAGE_KEY);
      const data = raw ? safeJsonParse(raw) : null;
      if (!data || typeof data !== "object") return structuredClone(base);
      return {
        ...structuredClone(base),
        ...data,
        settings: { ...base.settings, ...(data.settings || {}) },
        totals: { ...base.totals, ...(data.totals || {}) },
        perWord: data.perWord || {},
        run: data.run || null
      };
    };

    const save = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(store));

    const ensurePerWord = (term) => {
      if (!store.perWord[term]) {
        store.perWord[term] = { seen: 0, correct: 0, wrong: 0, lastSeen: null };
      }
      return store.perWord[term];
    };

    const formatTime = (ms) => {
      const s = Math.floor(ms / 1000);
      const mm = String(Math.floor(s / 60)).padStart(2, "0");
      const ss = String(s % 60).padStart(2, "0");
      return `${mm}:${ss}`;
    };

    const toast = (msg) => {
      const t = el("toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(() => t.classList.remove("show"), 1100);
    };

    const beep = (ok) => {
      if (!store.settings.sounds) return;
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "sine";
      o.frequency.value = ok ? 740 : 220;
      g.gain.value = 0.08;
      o.connect(g);
      g.connect(ctx.destination);
      o.start();
      o.stop(ctx.currentTime + 0.08);
      setTimeout(() => ctx.close(), 120);
    };

    const speak = (text) => {
      try{
        if (!("speechSynthesis" in window)) return toast("Speech not supported");
        const u = new SpeechSynthesisUtterance(text);
        u.rate = 0.95;
        u.pitch = 1.0;
        u.lang = "en-US";
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
      } catch {
        toast("Speech failed");
      }
    };

    const uniqueDeck = () => {
      const seen = new Set();
      const out = [];
      for (const w of WORDS) {
        const t = String(w.term || "").trim();
        const r = String(w.ru || "").trim();
        if (!t || !r) continue;
        const key = t.toLowerCase();
        if (seen.has(key)) continue;
        seen.add(key);
        out.push({ term: t, ru: r });
      }
      return out;
    };

    const deck = uniqueDeck();

    const buildOrder = (mode) => {
      const all = deck.map((w) => w.term);

      if (mode === "mistakes") {
        const only = all.filter((t) => (store.perWord[t]?.wrong || 0) > 0);
        return shuffle(only.length ? only.slice() : all.slice());
      }

      if (mode === "all") {
        return shuffle(all.slice());
      }

      const scored = all.map((t) => {
        const s = store.perWord[t] || { seen:0, correct:0, wrong:0, lastSeen:null };
        const weak = (s.wrong * 4) - (s.correct * 1.2) + (s.seen === 0 ? 3 : 0);
        const recency = s.lastSeen ? clamp((Date.now() - Date.parse(s.lastSeen)) / (1000*60*60*6), 0, 6) : 6;
        const score = weak + recency * 0.6;
        return { t, score };
      });

      scored.sort((a,b) => b.score - a.score);

      const top = scored.slice(0, Math.min(scored.length, 60)).map(x => x.t);
      const rest = scored.slice(Math.min(scored.length, 60)).map(x => x.t);

      return shuffle(top).concat(shuffle(rest));
    };

    const getWord = (term) => deck.find(w => w.term === term);

    const pickOptions = (correctRu) => {
      const pool = deck.map(w => w.ru).filter(x => x && x !== correctRu);
      shuffle(pool);
      const wrong = [];
      for (const t of pool) {
        if (wrong.length >= 3) break;
        if (!wrong.includes(t) && t !== correctRu) wrong.push(t);
      }
      const opts = shuffle([correctRu, ...wrong]);
      return { opts, correctIndex: opts.indexOf(correctRu) };
    };

    const updateTopStats = () => {
      const r = store.run;
      const correct = r ? r.correct : 0;
      const wrong = r ? r.wrong : 0;
      const total = correct + wrong;
      const acc = total ? Math.round((correct / total) * 100) : 0;

      ui.sCorrect.textContent = correct;
      ui.sWrong.textContent = wrong;
      ui.sAcc.textContent = `${acc}%`;
      ui.sStreak.textContent = r ? r.streak : 0;

      ui.sessionLeft.textContent = r ? `${Math.max(0, r.order.length - r.idx)} left` : "0 left";
      ui.sessionTime.textContent = r ? formatTime(Date.now() - r.startedAt) : "00:00";

      if (r) ui.sessionNote.textContent = `Mode: ${store.settings.mode} ‚Ä¢ Deck: ${r.order.length} cards`;
    };

    const updateProgress = () => {
      const r = store.run;
      if (!r) {
        ui.pLabel.textContent = "Ready";
        ui.pMeta.textContent = `0 / ${deck.length}`;
        ui.pBar.style.width = "0%";
        return;
      }
      const done = r.idx;
      const total = r.order.length;
      ui.pLabel.textContent = r.finished ? "Finished" : "In progress";
      ui.pMeta.textContent = `${Math.min(done + 1, total)} / ${total}`;
      ui.pBar.style.width = `${clamp(((done) / Math.max(1,total)) * 100, 0, 100)}%`;
    };

    const renderMistakes = () => {
      const r = store.run;
      const list = ui.mistakesList;
      list.innerHTML = "";
      if (!r || !r.mistakes.length) {
        list.innerHTML = `<div class="small">No mistakes yet.</div>`;
        return;
      }
      for (const m of r.mistakes.slice(-12).reverse()) {
        const d = document.createElement("div");
        d.className = "mist";
        d.innerHTML = `<div class="en">${m.term}</div><div class="ru">${m.correctRu}</div>`;
        list.appendChild(d);
      }
    };

    const setSwitch = (sw, on) => {
      sw.classList.toggle("on", !!on);
    };

    const syncSettingsUI = () => {
      ui.mode.value = store.settings.mode;
      ui.modeChip.textContent = `Mode: ${store.settings.mode[0].toUpperCase() + store.settings.mode.slice(1)}`;
      setSwitch(ui.swAuto, store.settings.autoAdvance);
      setSwitch(ui.swHard, store.settings.hardMode);
      setSwitch(ui.swSound, store.settings.sounds);
    };

    const setRun = (run) => {
      store.run = run;
      save();
      updateTopStats();
      updateProgress();
      renderMistakes();
    };

    const newRun = () => {
      const order = buildOrder(store.settings.mode);
      const run = {
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
        mode: store.settings.mode,
        order,
        idx: 0,
        correct: 0,
        wrong: 0,
        streak: 0,
        bestStreak: 0,
        startedAt: Date.now(),
        finished: false,
        current: null,
        answered: false,
        chosenIndex: null,
        correctIndex: null,
        options: [],
        mistakes: []
      };
      setRun(run);
      nextQuestion(true);
      toast("New run started");
    };

    const finalizeRun = () => {
      const r = store.run;
      if (!r || r.finished) return;
      r.finished = true;

      const total = r.correct + r.wrong;
      const acc = total ? Math.round((r.correct / total) * 100) : 0;
      const duration = Date.now() - r.startedAt;

      store.totals.correct += r.correct;
      store.totals.wrong += r.wrong;
      store.totals.sessions.unshift({
        at: nowISO(),
        mode: r.mode,
        correct: r.correct,
        wrong: r.wrong,
        accuracy: acc,
        durationMs: duration,
        bestStreak: r.bestStreak
      });
      store.totals.sessions = store.totals.sessions.slice(0, 60);

      save();

      ui.term.textContent = `Done ‚Äî ${acc}% accuracy`;
      ui.hint.innerHTML = `Run finished: <b>${r.correct}</b> correct, <b>${r.wrong}</b> wrong ‚Ä¢ Time: <b>${formatTime(duration)}</b> ‚Ä¢ Best streak: <b>${r.bestStreak}</b>.`;
      ui.options.innerHTML = "";
      ui.btnNext.disabled = true;

      updateTopStats();
      updateProgress();
      renderMistakes();

      toast("Finished!");
    };

    const nextQuestion = (force=false) => {
      const r = store.run;
      if (!r) return;

      if (store.settings.hardMode && !force && !r.answered && r.idx > 0) {
        toast("Answer first (Hard mode)");
        return;
      }

      if (r.idx >= r.order.length) return finalizeRun();

      const term = r.order[r.idx];
      const w = getWord(term);
      if (!w) {
        r.idx += 1;
        save();
        return nextQuestion(true);
      }

      const { opts, correctIndex } = pickOptions(w.ru);

      r.current = { term: w.term, ru: w.ru };
      r.options = opts;
      r.correctIndex = correctIndex;
      r.answered = false;
      r.chosenIndex = null;

      ui.term.textContent = w.term;
      ui.hint.textContent = "Choose the correct Russian translation.";

      ui.options.innerHTML = "";
      opts.forEach((txt, i) => {
        const b = document.createElement("button");
        b.className = "opt";
        b.type = "button";
        b.innerHTML = `<span class="k">${i+1}</span><span class="t">${txt}</span>`;
        b.addEventListener("click", () => answer(i));
        ui.options.appendChild(b);
      });

      ui.btnNext.disabled = true;
      updateTopStats();
      updateProgress();
      renderMistakes();
      save();
    };

    const lockOptions = () => {
      [...ui.options.querySelectorAll(".opt")].forEach(x => x.disabled = true);
    };

    const paintOptions = (chosenIndex, correctIndex) => {
      const nodes = [...ui.options.querySelectorAll(".opt")];
      nodes.forEach((n, i) => {
        n.classList.remove("correct", "wrong");
        if (i === correctIndex) n.classList.add("correct");
        if (i === chosenIndex && chosenIndex !== correctIndex) n.classList.add("wrong");
      });
    };

    const answer = (chosenIndex) => {
      const r = store.run;
      if (!r || r.finished) return;
      if (r.answered) return;

      r.answered = true;
      r.chosenIndex = chosenIndex;

      const term = r.current.term;
      const correctIndex = r.correctIndex;

      lockOptions();
      paintOptions(chosenIndex, correctIndex);

      const pw = ensurePerWord(term);
      pw.seen += 1;
      pw.lastSeen = nowISO();

      if (chosenIndex === correctIndex) {
        r.correct += 1;
        r.streak += 1;
        r.bestStreak = Math.max(r.bestStreak, r.streak);
        pw.correct += 1;
        toast("‚úÖ Correct");
        beep(true);
      } else {
        r.wrong += 1;
        r.streak = 0;
        pw.wrong += 1;

        const correctRu = r.options[correctIndex];
        r.mistakes.push({ term, correctRu });

        ui.hint.innerHTML = `Correct: <b>${correctRu}</b>`;
        toast("‚ùå Wrong");
        beep(false);
      }

      ui.btnNext.disabled = false;
      updateTopStats();
      renderMistakes();
      save();

      setTimeout(() => {
        if (store.settings.autoAdvance) {
          r.idx += 1;
          save();
          nextQuestion(true);
        }
      }, store.settings.autoAdvance ? 650 : 0);
    };

    const skip = () => {
      const r = store.run;
      if (!r || r.finished) return;

      if (!r.current) return;

      if (!r.answered) {
        answer(-1);
        return;
      }

      r.idx += 1;
      save();
      nextQuestion(true);
    };

    const resumeModal = (show) => {
      ui.resumeBack.classList.toggle("show", !!show);
      ui.resumeBack.setAttribute("aria-hidden", show ? "false" : "true");
    };

    const maybeOfferResume = () => {
      const r = store.run;
      if (!r || r.finished) return;
      if (!Array.isArray(r.order) || r.order.length === 0) return;
      if (r.idx >= r.order.length) return;

      const total = r.order.length;
      const at = formatTime(Date.now() - r.startedAt);
      ui.resumeText.innerHTML = `
        You have an unfinished run.<br/>
        Progress: <b>${Math.min(r.idx + 1, total)}</b> / <b>${total}</b><br/>
        Current score: <b>${r.correct}</b> correct, <b>${r.wrong}</b> wrong ‚Ä¢ Time: <b>${at}</b>
      `;
      resumeModal(true);
    };

    const exportResults = () => {
      const payload = {
        exportedAt: nowISO(),
        totals: store.totals,
        perWord: store.perWord,
        lastRun: store.run
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "sat-vocab-results.json";
      a.click();
      setTimeout(() => URL.revokeObjectURL(a.href), 1200);
      toast("Exported");
    };

    const clearAll = () => {
      localStorage.removeItem(STORAGE_KEY);
      store = structuredClone(base);
      syncSettingsUI();
      updateTopStats();
      updateProgress();
      renderMistakes();
      ui.term.textContent = "Press ‚ÄúStart‚Äù";
      ui.options.innerHTML = "";
      ui.hint.textContent = "Tip: answer fast, use keyboard, results are saved locally in your browser.";
      toast("Cleared");
    };

    let store = load();

    const tick = () => {
      if (store.run && !store.run.finished) updateTopStats();
      requestAnimationFrame(tick);
    };

    ui.btnStart.addEventListener("click", () => newRun());
    ui.btnRestart.addEventListener("click", () => newRun());

    ui.btnNext.addEventListener("click", () => {
      const r = store.run;
      if (!r || r.finished) return;
      if (!r.answered && store.settings.hardMode) return toast("Answer first (Hard mode)");
      r.idx += 1;
      save();
      nextQuestion(true);
    });

    ui.btnSkip.addEventListener("click", () => skip());
    ui.btnSpeak.addEventListener("click", () => {
      const r = store.run;
      const word = r?.current?.term || ui.term.textContent;
      if (word && word !== "Press ‚ÄúStart‚Äù") speak(word);
    });

    ui.btnExport.addEventListener("click", exportResults);
    ui.btnClear.addEventListener("click", clearAll);

    ui.mode.addEventListener("change", (e) => {
      store.settings.mode = e.target.value;
      syncSettingsUI();
      save();
      toast(`Mode: ${store.settings.mode}`);
    });

    const toggleSwitch = (key, node) => {
      store.settings[key] = !store.settings[key];
      setSwitch(node, store.settings[key]);
      syncSettingsUI();
      save();
      toast(`${key}: ${store.settings[key] ? "ON" : "OFF"}`);
    };

    ui.swAuto.addEventListener("click", () => toggleSwitch("autoAdvance", ui.swAuto));
    ui.swHard.addEventListener("click", () => toggleSwitch("hardMode", ui.swHard));
    ui.swSound.addEventListener("click", () => toggleSwitch("sounds", ui.swSound));

    document.addEventListener("keydown", (e) => {
      const r = store.run;
      if (!r || r.finished) return;

      const k = e.key.toLowerCase();

      if (k === "enter") {
        e.preventDefault();
        if (r.answered) ui.btnNext.click();
        return;
      }

      if (k === "s") {
        e.preventDefault();
        ui.btnSkip.click();
        return;
      }

      if (k === " ") {
        e.preventDefault();
        ui.btnSpeak.click();
        return;
      }

      if (["1","2","3","4"].includes(e.key)) {
        e.preventDefault();
        const idx = Number(e.key) - 1;
        if (!r.answered) answer(idx);
      }
    });

    ui.btnResume.addEventListener("click", () => {
      resumeModal(false);
      nextQuestion(true);
      toast("Resumed");
    });
    ui.btnDiscardResume.addEventListener("click", () => {
      resumeModal(false);
      store.run = null;
      save();
      newRun();
    });
    ui.btnCloseResume.addEventListener("click", () => resumeModal(false));

    syncSettingsUI();
    updateTopStats();
    updateProgress();
    renderMistakes();
    maybeOfferResume();
    tick();
  </script>
</body>
</html>
